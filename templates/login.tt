<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>Thruk Monitoring Webinterface</title>
    <link rel="shortcut icon" href="[% url_prefix %]themes/[% theme %]/images/favicon.ico" type="image/ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    [% PROCESS _common_css.tt use_frames=1 %]
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    [% PROCESS _common_js_files.tt %]
  </head>
  <body class='[% page %] loginpage' id='[% page %]'>
  [% PROCESS _common_js.tt %]
  [% IF ssi_header; ssi_header | evaltt; END %]
  [% PROCESS _header_broadcast.tt %]
  [% PROCESS _message.tt %]

  <div class="loginmask">
    <a href="[% c.config.home_link %]" target="_blank"><img src="[% url_prefix %]themes/[% theme %]/images/logo_thruk.png" alt="Thruk" title="Thruk"></a>
    <form method="POST" action="login.cgi">
      <input type="hidden" name="referer" value="" id="referer">
      [% IF c.config.basic_auth_enabled %]
        <div>
          <input type="text" name="login" placeholder="User" id="loginuser"[% IF !c.config.basic_auth_enabled || c.config.auth_oauth.provider.size == 0 %] required[% END %] />
        </div>
        <div class="togglePassword">
          <input type="password" name="password" placeholder="Password"[% IF !c.config.basic_auth_enabled || c.config.auth_oauth.provider.size == 0 %] required[% END %] />
          <i class="eye-slash togglePassword"></i>
        </div>
        <button type="submit">Sign in</button>
      [% END %]
      [% IF c.config.basic_auth_enabled || c.config.auth_oauth.provider.size > 0 %]
        [% FOREACH auth = c.config.auth_oauth.provider %]
          [% IF c.config.basic_auth_enabled || !loop.first %]
          <div class="separator">or</div>
          [% END %]
        <div>
          <button name="oauth" value="[% loop.index %]">[% IF auth.defined("login") %][% auth.login %][% ELSE %]Login with OAuth[% END %]</button>
        </div>
        [% END %]
      [% END %]
    </form>
    <div class="currentversioninfo">
      <div class="version"><a href="https://www.thruk.org/" target="_blank">Version [% thrukversion %][% IF c.config.extra_version %]<br><font size="-3">[% c.config.extra_version %]</font>[% END %]</a></div>
    </div>
  </div>

  <script type="text/javascript">
  <!--
    function clean_ref(ref, keepflag) {
        ref = ref.replace(/\/\w+\/[% product_prefix %]\/cgi\-bin\/login.cgi/, '');
        ref = ref.replace(/\/[% product_prefix %]\/cgi\-bin\/login.cgi/, '');
        if(keepflag == undefined || keepflag == false) {
            ref = ref.replace(/^\?(expired|invalid|problem|locked)\&/, '?');
            ref = ref.replace(/^\?(expired|invalid|problem|locked)$/,  '');
        }
        ref = ref.replace(/^\?/, '/');
        ref = ref.replace(/^\/+/, '/');
        ref = ref.replace(/^\?/, '/');
        ref = ref.replace(/^\/(expired|invalid|problem|locked)\&/,  '$1&/');
        ref = ref.replace(/_=\d+/, '');
        ref = ref.replace(/\?$/, '');
        ref = ref.replace(/\#side.html$/, '');
        return(ref);
    }

    function breakFrame() {
        // only redirect in real frames, we only want to hide the sidebar if logged out
        // but not break iframes from ex. graphing popups
        if ( window.frameElement && window.frameElement.tagName == "FRAME" && top.location != location) {
            // when inside a frame, open login page in top frame
            var ref = clean_ref(document.location.pathname + document.location.search + document.location.hash, true);
            ref = ref.replace(/\/thruk\//, '/thruk/#');
            top.location.href = '[% loginurl %]?'+ref;
        } else {
            var ref = clean_ref(window.location.search + window.location.hash);
            var el  = document.getElementById('referer');
            ref = decodeURIComponent(ref).replace(/\+/g, " ");
            if(el) { el.value = ref; }
        }
        return;
    }

    try {
        breakFrame();
    } catch(err) { console.log(err); }
  -->
  </script>

  [% IF ssi_footer; ssi_footer | evaltt; END %]
  </body>
</html>
